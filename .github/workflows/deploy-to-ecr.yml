name: Deploy to Amazon ECR

on:
  # Trigger on push to main branch
  push:
    branches:
      - main
  
  # Allow manual trigger from Actions tab
  workflow_dispatch:

env:
  AWS_REGION: us-east-1  # Change to your region
  ECR_REPOSITORY: usda-dashboard  # Change to your ECR repo name

jobs:
  deploy:
    name: Build and Push to ECR
    runs-on: ubuntu-latest
    
    # Required permissions for OIDC authentication
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Option 1: Using OIDC (recommended - no long-lived credentials)
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
          
          # Option 2: Using access keys (set these in GitHub Secrets if not using OIDC)
          # Uncomment these lines and comment out role-to-assume if using access keys:
          # aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          # aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Build Docker image
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          
          # Push both tags (git SHA and latest)
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "Image pushed to ECR:"
          echo "  - $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "  - $ECR_REGISTRY/$ECR_REPOSITORY:latest"
      
      - name: Summary
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "### Deployment Summary :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image URI:**" >> $GITHUB_STEP_SUMMARY
          echo "\`$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Latest tag:**" >> $GITHUB_STEP_SUMMARY
          echo "\`$ECR_REGISTRY/$ECR_REPOSITORY:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to AWS App Runner console" >> $GITHUB_STEP_SUMMARY
          echo "2. Trigger a new deployment with the latest image" >> $GITHUB_STEP_SUMMARY
          echo "3. Or run: \`aws apprunner start-deployment --service-arn <your-service-arn>\`" >> $GITHUB_STEP_SUMMARY
          
      # Optional: Automatically trigger App Runner deployment
      # Uncomment this step if you want automatic deployments
      # - name: Deploy to App Runner
      #   env:
      #     SERVICE_ARN: ${{ secrets.APP_RUNNER_SERVICE_ARN }}
      #   run: |
      #     aws apprunner start-deployment --service-arn $SERVICE_ARN
      #     echo "Triggered App Runner deployment"
